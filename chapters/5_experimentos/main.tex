\graphicspath{{chapters/5_experimentos/figures/}}

\chapter{Experimentación}\label{chap:experiments}

Para analizar el rendimiento de la implementación, se realizaron experimentos en distintas tarjetas gráficas, las cuales se ven en el cuadro \ref{tab:hardware-used}.
Las escenas utilizadas se muestran en las figuras \ref{fig:cornell-box-full} y \ref{fig:sponza}, las llamaremos $S1$ y $S2$ respectivamente.
Se puede observar en cada una de ellas la luz indirecta difusa, luz indirecta especular y sombras suaves.

\begin{table}[ht]
	\centering
	\begin{tabular}{|c|c|c|c|c|}
		\hline
		\textbf{Nombre} & \textbf{GPU} & \textbf{Núcleos} & \textbf{Clock (GHz)} & \textbf{VRAM (GB)} \\
		\hline
		$H1$ & Intel Mesa ADL GT2 & 96 & 1.45 & * \\
		\hline
		$H2$ & Nvidia GTX 1660 Ti mobile & 1536 & 1.45 & 6 \\
		\hline
		$H3$ & Nvidia Geforce RTX 4070 & 5888 & 1.92 & 12 \\
		\hline
	\end{tabular}
	\caption{Hardware utilizado. * al ser una tarjeta integrada, usa la memoria de la CPU.}
	\label{tab:hardware-used}
\end{table}

\begin{figure}[H]
	\centering
	  \begin{subfigure}{0.49\textwidth}
	      \centering
	  \includegraphics[width=\textwidth]{cornell-box-direct.png}
	      \caption{Solo luz directa.}
	  \end{subfigure}
	  \begin{subfigure}{0.49\textwidth}
	      \centering
	  \includegraphics[width=\textwidth]{cornell-box-full.png}
	      \caption{Luz directa e indirecta.}
	  \end{subfigure}
	\caption{Escena de prueba con geometría simple.}
	\label{fig:cornell-box-full}
\end{figure}

\begin{figure}[H]
	\begin{subfigure}{0.49\textwidth}
	  \centering
	  \includegraphics[width=\textwidth]{sponza-direct.png}
	  \caption{Solo luz directa.}
	\end{subfigure}
	\begin{subfigure}{0.49\textwidth}
	  \centering
	  \includegraphics[width=\textwidth]{sponza-all.png}
	  \caption{Luz directa e indirecta.}
	\end{subfigure}
	\caption{Sponza.}
	\label{fig:sponza}
\end{figure}

Los experimentos varían la cantidad de vóxeles por dimensión, y registran los cuadros por segundo alcanzados (FPS, por sus siglas en inglés) y el tiempo de construcción del \textit{octree} en segundos.
Para conseguir los FPS se ejecutó el programa durante un minuto, tomando una muestra cada segundo, luego se promediaron.
Para el tiempo de construcción del \textit{octree}, se construyó 50 veces y se calculó el tiempo promedio.
Cada ejecución se realizó independientemente, para evitar posibles mejoras debido al uso del cache.

En el cuadro \ref{tab:experiment-results} se muestran los resultados de estos experimentos en tarjetas Intel Mesa ADL GT2 integrada de laptop, Nvidia GTX 1660 Ti de laptop y Nvidia RTX 4070.
En cada tabla se muestran los resultados para cada una de las escenas $S1$ y $S2$.

\begin{table}[ht]
\centering
\begin{tabular}{|c|c|c|c|c|}
	\hline
	\textbf{Escena} & \textbf{Hardware} & \textbf{Vóxeles} & \textbf{FPS} & \textbf{Construcción del \textit{octree} (s)} \\
	\hline
	$S1$ & $H1$ & $256$ & $14.47$ & $4.62$ \\
	\cline{3-5}
	 & & $512$ & $11.30$ & $5.04$ \\
	\cline{3-5}
	 & & $1024$ & $9.22$ & $4.40$ \\
	\cline{2-5}
	 & $H2$ & $256$ & $136.57$ & $1.78$ \\
	\cline{3-5}
	 & & $512$ & $108.67$ & $1.80$ \\
	\cline{3-5}
	 & & $1024$ & $60.24$ & $1.89$ \\
	\cline{2-5}
	 & $H3$ & $256$ & $141.57$ & $1.88$ \\
	\cline{3-5}
	 & & $512$ & $141.47$ & $1.90$ \\
	\cline{3-5}
	 & & $1024$ & $140.88$ & $1.89$ \\
	\hline
	$S2$ & $H1$ & $256$ & $17.05$ & $3.82$ \\
	\cline{3-5}
	 & & $512$ & $14.08$ & $3.66$ \\
	\cline{3-5}
	 & & $1024$ & $12.57$ & $3.78$ \\
	\cline{2-5}
	 & $H2$ & $256$ & $59.68$ & $1.82$ \\
	\cline{3-5}
	 & & $512$ & $37.42$ & $1.94$ \\
	\cline{3-5}
	 & & $1024$ & $9.83$ & $1.83$ \\
	\cline{2-5}
	 & $H3$ & $256$ & $141.27$ & $1.70$ \\
	\cline{3-5}
	 & & $512$ & $141.51$ & $1.91$ \\
	\cline{3-5}
	 & & $1024$ & $141.21$ & $1.99$ \\
	\hline
\end{tabular}
\caption{FPS y tiempo de construcción del octree para cada escena.}
\label{tab:experiment-results}
\end{table}

\section{Análisis de resultados}

Una observación es la falta de rendimiento, dado que en las tarjetas gráficas de laptops en las que se ejecutó, se consiguieron muy pocos cuadros por segundo y en todas las tarjetas los tiempos de construcción del octree fueron muy altos.
Los valores de estas métricas son mucho mejores en el artículo original del algoritmo, en el que se mostraron entre 20 y 30 cuadros por segundo y 280 milisegundos de construcción del \textit{octree}, en lugar de segundos.

Una observación es que la tarjeta Nvidia RTX 4070 trae excelentes resultados en terminos de cuadros por segundo, pero sorprendentemente es más lenta que la Intel Mesa ADL GT2 en construír el \textit{octree}.
Esto puede deberse a que la primer tarjeta posee mucho más paralelización, por lo que puede realizar todos los trazados de conos sin problemas, pero este no es el cuello de botella para la construcción del \textit{octree}, sino la comunicación entre CPU y GPU.

Fingxels logró correr escenas a aproximadamente 15 FPS en tarjetas gráficas de laptops, mientras que el artículo original logró aproximadamente 30 FPS.
En una tarjeta de última generación se lograron aproximadamente 140 FPS.
Sin embargo, el tiempo de construcción de la estructura de datos fue mucho más lento que en el trabajo original para todas las tarjetas probadas.
